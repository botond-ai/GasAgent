name: Deploy RAG Agent to Local Server

# Trigger: Manu√°lis ind√≠t√°s GitHub Actions UI-b≈ël
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  DEPLOY_PATH: /home/ubuntu/ai-agents-hu/mini_projects/gabor.toth
  SERVICE_NAME: rag-agent
  BACKEND_HEALTH_CHECK: http://localhost:8000/api/health
  FRONTEND_HEALTH_CHECK: http://localhost:3000

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
      # 0. Code checkout
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 1. SSH setup
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
      
      # 2. Pre-deployment health check (van-e m≈±k√∂d≈ë service?)
      - name: Pre-Deployment Health Check
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          
          echo "üîç Checking current deployment status..."
          cd ${{ env.DEPLOY_PATH }}
          
          BACKEND_OK=false
          FRONTEND_OK=false
          
          # Backend health check
          if curl -s --connect-timeout 2 ${{ env.BACKEND_HEALTH_CHECK }} > /dev/null 2>&1; then
            echo "‚úÖ Current backend is running"
            BACKEND_OK=true
          else
            echo "‚ö†Ô∏è  Current backend is not responding (this is OK for first deploy)"
          fi
          
          # Frontend health check
          if curl -s --connect-timeout 2 ${{ env.FRONTEND_HEALTH_CHECK }} > /dev/null 2>&1; then
            echo "‚úÖ Current frontend is running"
            FRONTEND_OK=true
          else
            echo "‚ö†Ô∏è  Current frontend is not responding"
          fi
          
          EOF
      
      # 3. Backup persistent data (szez√≥n√°lis)
      - name: Backup Data
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          set -e
          
          echo "üíæ Backing up persistent data..."
          cd ${{ env.DEPLOY_PATH }}
          
          # Backup only if data exists
          if [ -d "data" ]; then
            BACKUP_DIR="data/.backup_$(date +%s)"
            mkdir -p "$BACKUP_DIR"
            
            cp -r data/users "$BACKUP_DIR/" 2>/dev/null || echo "  No users data to backup"
            cp -r data/sessions "$BACKUP_DIR/" 2>/dev/null || echo "  No sessions data to backup"
            
            echo "‚úÖ Data backed up to: $BACKUP_DIR"
          else
            echo "‚ÑπÔ∏è  No data directory found (first deploy)"
          fi
          
          EOF
      
      # 4. Git pull + dependencies update
      - name: Pull Latest Code
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          set -e
          
          echo "üìÅ Navigating to deployment directory..."
          cd ${{ env.DEPLOY_PATH }}
          
          echo "üì° Pulling latest code from main branch..."
          git fetch origin
          git checkout main
          git pull origin main
          
          echo "‚úÖ Code pulled successfully"
          EOF
      
      # 5. Graceful Docker Compose Update (zero-downtime, ha nincs config v√°ltoz√°s)
      - name: Update Docker Services (Graceful)
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          set -e
          
          cd ${{ env.DEPLOY_PATH }}
          
          echo "üê≥ Updating Docker images..."
          docker-compose pull || true
          
          echo "üî® Building and starting services (graceful restart)..."
          docker-compose up -d --build
          
          echo "‚è≥ Allowing services to stabilize (10s)..."
          sleep 10
          
          echo "‚úÖ Services updated"
          EOF
      
      # 6. Health Check - Backend
      - name: Health Check - Backend
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          set -e
          
          MAX_ATTEMPTS=30
          ATTEMPT=1
          WAIT_TIME=10
          
          echo "üè• Health checking backend (max $(($MAX_ATTEMPTS * $WAIT_TIME))s)..."
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "  Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            if curl -s --connect-timeout 5 ${{ env.BACKEND_HEALTH_CHECK }} > /dev/null 2>&1; then
              echo "‚úÖ Backend is healthy!"
              exit 0
            fi
            
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              sleep $WAIT_TIME
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "‚ùå Backend health check failed after $(($MAX_ATTEMPTS * $WAIT_TIME))s"
          echo "üìã Docker logs:"
          cd ${{ env.DEPLOY_PATH }}
          docker-compose logs backend --tail=50
          exit 1
          EOF
      
      # 7. Health Check - Frontend
      - name: Health Check - Frontend
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          set -e
          
          MAX_ATTEMPTS=15
          ATTEMPT=1
          WAIT_TIME=5
          
          echo "üè• Health checking frontend (max $(($MAX_ATTEMPTS * $WAIT_TIME))s)..."
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "  Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            # Frontend should return 200 OK
            if curl -s --connect-timeout 3 -I ${{ env.FRONTEND_HEALTH_CHECK }} | grep -q "200\|301"; then
              echo "‚úÖ Frontend is healthy!"
              exit 0
            fi
            
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              sleep $WAIT_TIME
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "‚ö†Ô∏è  Frontend health check timeout (may be normal for nginx startup)"
          echo "üìã Docker logs:"
          cd ${{ env.DEPLOY_PATH }}
          docker-compose logs frontend --tail=20
          EOF
      
      # 8. Smoke Test (opcion√°lis alapvet≈ës√©g ellen≈ërz√©se)
      - name: Smoke Test
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          set -e
          
          echo "üß™ Running smoke tests..."
          cd ${{ env.DEPLOY_PATH }}
          
          # Test backend responds with expected structure
          echo "  Testing backend API..."
          RESPONSE=$(curl -s ${{ env.BACKEND_HEALTH_CHECK }})
          if echo "$RESPONSE" | grep -q "ok"; then
            echo "  ‚úÖ Backend API responds correctly"
          else
            echo "  ‚ö†Ô∏è  Backend response unexpected: $RESPONSE"
          fi
          
          echo "‚úÖ Smoke tests completed"
          EOF
      
      # 9. Detailed Deployment Logs
      - name: Verify Deployment Logs
        if: success()
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          cd ${{ env.DEPLOY_PATH }}
          
          echo "üìã Services Status:"
          docker-compose ps
          
          echo ""
          echo "üìã Backend logs (last 15 lines):"
          docker-compose logs backend --tail=15
          
          echo ""
          echo "üìã Frontend logs (last 15 lines):"
          docker-compose logs frontend --tail=15
          
          echo ""
          echo "üìä Resource Usage:"
          docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
          EOF
      
      # 10. Deployment Success Summary
      - name: Deployment Success
        if: success()
        run: |
          cat << 'EOF'
          
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë            ‚úÖ DEPLOYMENT SUCCESSFUL ‚úÖ                     ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          
          üì¶ Service: RAG Agent
          üåç Server: ${{ secrets.DEPLOY_HOST }}
          üìÇ Path: ${{ env.DEPLOY_PATH }}
          
          üîó Backend:  ${{ env.BACKEND_HEALTH_CHECK }}
          üîó Frontend: ${{ env.FRONTEND_HEALTH_CHECK }}
          
          ‚úÖ Health checks passed
          ‚úÖ Services are stable
          ‚úÖ Data backed up before deployment
          
          üöÄ Application is now live!
          
          EOF
      
      # 11. Failure notification
      - name: Deployment Failed
        if: failure()
        run: |
          cat << 'EOF'
          
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë                  ‚ùå DEPLOYMENT FAILED ‚ùå                    ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          
          üì¶ Service: RAG Agent
          üåç Server: ${{ secrets.DEPLOY_HOST }}
          
          ‚ö†Ô∏è  Deployment failed. Check the logs above for details.
          
          üìã Common issues & fixes:
          
          1. SSH Connection Failed
             ‚Üí Check DEPLOY_SSH_KEY and DEPLOY_HOST secrets
             ‚Üí Verify SSH key is authorized on VPS
          
          2. Git Pull Failed
             ‚Üí Verify git credentials on VPS
             ‚Üí Check if main branch exists
          
          3. Docker Build Failed
             ‚Üí Check Docker image sizes (disk space?)
             ‚Üí Review docker-compose.yml syntax
          
          4. Health Check Timeout
             ‚Üí Backend not starting: docker-compose logs backend
             ‚Üí OPENAI_API_KEY missing in .env
             ‚Üí Port 8000 already in use
          
          5. Backend health check fails
             ‚Üí Check OPENAI_API_KEY is set in .env
             ‚Üí Verify database connectivity (ChromaDB)
             ‚Üí Check for Python dependency issues
          
          6. Frontend health check fails
             ‚Üí nginx might be slow to start
             ‚Üí Check port 5173 is available
             ‚Üí Review frontend build process
          
          üîß Recovery steps:
          1. SSH to VPS: ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}
          2. Check logs: cd ${{ env.DEPLOY_PATH }} && docker-compose logs
          3. Rollback: git reset --hard HEAD~1 && docker-compose down && docker-compose up -d
          
          EOF
          exit 1
      
      # 12. SSH cleanup
      - name: Cleanup SSH Key
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          echo "üîê SSH key cleaned up"