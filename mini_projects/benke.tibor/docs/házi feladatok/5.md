# HÃ¡zi Feladat 5: Deployment Pipeline Terv - KnowledgeRouter AI Agent

## ğŸ“‹ TartalomjegyzÃ©k

1. [Projekt ÃttekintÃ©s](#projekt-Ã¡ttekintÃ©s)
2. [Jelenlegi ArchitektÃºra](#jelenlegi-architektÃºra)
3. [Deployment StratÃ©gia VÃ¡lasztÃ¡s](#deployment-stratÃ©gia-vÃ¡lasztÃ¡s)
4. [AWS Deployment Terv](#aws-deployment-terv)
5. [Terraform InfrastruktÃºra](#terraform-infrastruktÃºra)
6. [GitHub Actions CI/CD Pipeline](#github-actions-cicd-pipeline)
7. [KÃ¶ltsÃ©gbecslÃ©s](#kÃ¶ltsÃ©gbecslÃ©s)
8. [ImplementÃ¡ciÃ³s Ãœtemterv](#implementÃ¡ciÃ³s-Ã¼temterv)
9. [KockÃ¡zatelemzÃ©s](#kockÃ¡zatelemzÃ©s)

---

## Projekt ÃttekintÃ©s

### Mi a KnowledgeRouter?

**AI-powered Knowledge Management System** Django + LangGraph backend-del, amely:
- Multi-domain RAG (IT + HR tudÃ¡sbÃ¡zisok)
- Qdrant vector database (RAG retrieval)
- Redis caching (session + cache)
- PostgreSQL (feedback, user data)
- Prometheus + Grafana monitoring
- LangGraph orchestration (11-node custom workflow)

### Jelenlegi Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KNOWLEDGEROUTER STACK                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ–¥ï¸  BACKEND (Django + LangGraph)
â”œâ”€â”€ Python 3.11
â”œâ”€â”€ Django REST Framework
â”œâ”€â”€ LangGraph (StateGraph orchestration)
â”œâ”€â”€ LangChain (OpenAI integration)
â””â”€â”€ Uvicorn/Gunicorn ASGI server

ğŸ’¾ DATABASES & STORAGE
â”œâ”€â”€ PostgreSQL (user data, feedback)
â”œâ”€â”€ Qdrant (vector DB - RAG embeddings)
â””â”€â”€ Redis (cache + session)

ğŸ¨ FRONTEND
â”œâ”€â”€ Vanilla JavaScript
â”œâ”€â”€ Tailwind CSS
â””â”€â”€ Nginx (static serving)

ğŸ“Š MONITORING
â”œâ”€â”€ Prometheus (metrics collection)
â””â”€â”€ Grafana (dashboards)

ğŸ”Œ EXTERNAL APIs
â”œâ”€â”€ OpenAI API (GPT-4o-mini)
â”œâ”€â”€ Confluence (knowledge retrieval)
â””â”€â”€ Jira (ticket integration)
```

---

## Jelenlegi ArchitektÃºra

### Docker Compose Setup (LokÃ¡lis FejlesztÃ©s)

```yaml
services:
  backend:        # Django + LangGraph (port 8001 â†’ 8000)
  frontend:       # Nginx + Tailwind (port 3000 â†’ 80)
  qdrant:         # Vector DB (port 6333)
  redis:          # Cache + sessions (port 6379)
  postgres:       # Relational DB (port 5432)
  prometheus:     # Metrics (port 9090)
  grafana:        # Dashboards (port 3001)
```

**Ã–sszesen: 7 kontÃ©ner** a lokÃ¡lis stack-ben.

### Networking

- Megosztott network: `knowledge_network`
- Backend environment variables: 40+ (OpenAI, Qdrant, Redis, Postgres, Confluence, Jira)
- Volumes: Backend hot-reload, data persistence, credentials

### ProblÃ©mÃ¡k a Production Deploymenthez

âŒ **Egyetlen host-ra van optimalizÃ¡lva** (docker-compose)
âŒ **Nincs auto-scaling** (fix 1 backend container)
âŒ **Nincs load balancing** (egyetlen port expose)
âŒ **Nincs high availability** (1 instance minden szolgÃ¡ltatÃ¡sbÃ³l)
âŒ **Secrets management**: .env fÃ¡jlban (nem biztonsÃ¡gos production-ben)
âŒ **Nincs CI/CD pipeline** (manuÃ¡lis deployment)

---

## Deployment StratÃ©gia VÃ¡lasztÃ¡s

### OpciÃ³ 1: AWS ECS Fargate (Serverless Containers) âœ… VÃLASZTOTT

**ElÅ‘nyÃ¶k:**
- âœ… Serverless: nincs EC2 instance menedzsment
- âœ… Auto-scaling beÃ©pÃ­tett
- âœ… Pay-per-use: csak a futÃ³ vCPU+RAM Ã³rÃ¡Ã©rt fizetsz
- âœ… ALB integrÃ¡ciÃ³: load balancing + health checks
- âœ… CloudWatch logs: automatikus log aggregÃ¡ciÃ³
- âœ… Terraform tÃ¡mogatÃ¡s: teljes IaC
- âœ… Alacsony operational overhead

**HÃ¡trÃ¡nyok:**
- âŒ DrÃ¡gÃ¡bb mint EC2 (ha 24/7 fut)
- âŒ Cold start lehet (ha scale to zero)
- âŒ LimitÃ¡lt GPU support (AI workload-oknÃ¡l gond lehet)

**MiÃ©rt ez a legjobb vÃ¡lasztÃ¡s?**
- EgyszerÅ± kezdÃ©shez (nincs Kubernetes complexity)
- KivÃ¡lÃ³ Django + PostgreSQL + Redis + Qdrant workload-okhoz
- Auto-scaling az AI agent terhelÃ©snÃ©l kritikus
- CloudWatch integrÃ¡ciÃ³ a Prometheus mellett

---

### OpciÃ³ 2: AWS EKS (Kubernetes) âŒ NEM MOST

**ElÅ‘nyÃ¶k:**
- âœ… Teljes kontroll (Kubernetes native)
- âœ… Multi-cloud portability
- âœ… Rich ecosystem (Helm, operators)

**HÃ¡trÃ¡nyok:**
- âŒ Magas komplexitÃ¡s (cluster management)
- âŒ DrÃ¡ga (EC2 node-ok + control plane)
- âŒ Operational overhead (upgrades, security patches)

**MiÃ©rt NEM?**
- TÃºl komplex egy 7-kontÃ©neres alkalmazÃ¡shoz
- Nincs szÃ¼ksÃ©g multi-cloud portability-re (AWS-re optimalizÃ¡lunk)
- ECS Fargate egyszerÅ±bb Ã©s olcsÃ³bb

---

### OpciÃ³ 3: Google Cloud Run âŒ NEM AWS

**ElÅ‘nyÃ¶k:**
- âœ… Teljes serverless (scale to zero)
- âœ… EgyszerÅ± deployment
- âœ… Ingyenes tier (generous limits)

**HÃ¡trÃ¡nyok:**
- âŒ Nem AWS (tutorial AWS-re Ã©pÃ¼l)
- âŒ KorlÃ¡tozott networking (VPC connector kell)
- âŒ Nincs managed Qdrant/Redis/Postgres (kÃ¼lÃ¶n kell felÃ¡llÃ­tani)

---

## AWS Deployment Terv

### ArchitektÃºra Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AWS VPC (eu-central-1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Internet Gateway                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                                                     â”‚
â”‚               â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       Application Load Balancer (ALB)                        â”‚  â”‚
â”‚  â”‚       - Public IP: *.eu-central-1.elb.amazonaws.com          â”‚  â”‚
â”‚  â”‚       - Security Group: HTTP (80), HTTPS (443)               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                                                     â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚       â–¼                â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ AZ-1        â”‚  â”‚ AZ-2        â”‚  (High Availability)             â”‚
â”‚  â”‚ eu-c-1a     â”‚  â”‚ eu-c-1b     â”‚                                  â”‚
â”‚  â”‚ 10.0.1.0/24 â”‚  â”‚ 10.0.2.0/24 â”‚                                  â”‚
â”‚  â”‚             â”‚  â”‚             â”‚                                  â”‚
â”‚  â”‚ ECS Tasks:  â”‚  â”‚ ECS Tasks:  â”‚                                  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                  â”‚
â”‚  â”‚ â”‚Backend  â”‚ â”‚  â”‚ â”‚Backend  â”‚ â”‚ (Auto-scaling: 2-10 tasks)      â”‚
â”‚  â”‚ â”‚(Fargate)â”‚ â”‚  â”‚ â”‚(Fargate)â”‚ â”‚                                  â”‚
â”‚  â”‚ â”‚0.5 vCPU â”‚ â”‚  â”‚ â”‚0.5 vCPU â”‚ â”‚                                  â”‚
â”‚  â”‚ â”‚1 GB RAM â”‚ â”‚  â”‚ â”‚1 GB RAM â”‚ â”‚                                  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚                                  â”‚
â”‚  â”‚      â”‚      â”‚  â”‚      â”‚      â”‚                                  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”‚                                  â”‚
â”‚  â”‚ â”‚Frontend â”‚ â”‚  â”‚ â”‚Frontend â”‚ â”‚ (2 tasks)                        â”‚
â”‚  â”‚ â”‚(Fargate)â”‚ â”‚  â”‚ â”‚(Fargate)â”‚ â”‚                                  â”‚
â”‚  â”‚ â”‚0.25vCPU â”‚ â”‚  â”‚ â”‚0.25vCPU â”‚ â”‚                                  â”‚
â”‚  â”‚ â”‚512MB RAMâ”‚ â”‚  â”‚ â”‚512MB RAMâ”‚ â”‚                                  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                  â”‚
â”‚  â”‚             â”‚  â”‚             â”‚                                  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚  â”‚ â”‚   Managed Services (Fargate)    â”‚                             â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
â”‚  â”‚ â”‚ Qdrant      (1 task, 1GB RAM)   â”‚                             â”‚
â”‚  â”‚ â”‚ Redis       (1 task, 512MB)     â”‚                             â”‚
â”‚  â”‚ â”‚ Prometheus  (1 task, 1GB RAM)   â”‚                             â”‚
â”‚  â”‚ â”‚ Grafana     (1 task, 512MB)     â”‚                             â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  RDS PostgreSQL (Multi-AZ)                                   â”‚  â”‚
â”‚  â”‚  - Instance: db.t3.micro (1 vCPU, 1GB RAM)                   â”‚  â”‚
â”‚  â”‚  - Storage: 20GB SSD (gp3)                                   â”‚  â”‚
â”‚  â”‚  - Backup: 7 days retention                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ External Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚  ECR (Elastic Container Registry)                          â”‚
â”‚  â”œâ”€â”€ knowledgerouter-backend:latest                        â”‚
â”‚  â”œâ”€â”€ knowledgerouter-frontend:latest                       â”‚
â”‚  â”œâ”€â”€ qdrant/qdrant:v1.7.0                                  â”‚
â”‚  â”œâ”€â”€ redis:7-alpine                                        â”‚
â”‚  â”œâ”€â”€ prom/prometheus:v2.48.0                               â”‚
â”‚  â””â”€â”€ grafana/grafana:10.2.2                                â”‚
â”‚                                                             â”‚
â”‚  S3 Buckets                                                 â”‚
â”‚  â”œâ”€â”€ terraform-state-benke-tibor                           â”‚
â”‚  â””â”€â”€ knowledgerouter-data (user uploads, backups)          â”‚
â”‚                                                             â”‚
â”‚  Secrets Manager                                            â”‚
â”‚  â”œâ”€â”€ /knowledgerouter/openai-api-key                       â”‚
â”‚  â”œâ”€â”€ /knowledgerouter/confluence-credentials               â”‚
â”‚  â”œâ”€â”€ /knowledgerouter/jira-credentials                     â”‚
â”‚  â””â”€â”€ /knowledgerouter/postgres-password                    â”‚
â”‚                                                             â”‚
â”‚  CloudWatch Logs                                            â”‚
â”‚  â”œâ”€â”€ /ecs/knowledgerouter/backend                          â”‚
â”‚  â”œâ”€â”€ /ecs/knowledgerouter/frontend                         â”‚
â”‚  â”œâ”€â”€ /ecs/knowledgerouter/qdrant                           â”‚
â”‚  â””â”€â”€ /ecs/knowledgerouter/monitoring                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Komponens Breakdown

#### 1. Networking (VPC)

| ErÅ‘forrÃ¡s | KonfigurÃ¡ciÃ³ | IndoklÃ¡s |
|-----------|-------------|----------|
| VPC | 10.0.0.0/16 (65,536 IP) | BÅ‘sÃ©ges cÃ­mtÃ©r jÃ¶vÅ‘beli bÅ‘vÃ­tÃ©shez |
| Public Subnet 1 | 10.0.1.0/24 (AZ-1) | ALB + Fargate tasks (nat GW-n keresztÃ¼l) |
| Public Subnet 2 | 10.0.2.0/24 (AZ-2) | High Availability (2 AZ minimum) |
| Internet Gateway | 1 db | KÃ¼lsÅ‘ internet elÃ©rÃ©s |
| NAT Gateway | âŒ NINCS | Fargate tasks public subnet-ben (cost saving) |
| Security Groups | 3 db | ALB, ECS tasks, RDS |

**NAT Gateway nÃ©lkÃ¼l?**
- âœ… KÃ¶ltsÃ©gmegtakarÃ­tÃ¡s: ~$35/hÃ³/NAT GW
- âŒ Trade-off: ECS tasks public subnet-ben (public IP-vel)
- âœ… BiztonsÃ¡g: Security Groups + IAM Roles vÃ©dik
- ğŸ’¡ Production-ben: NAT Gateway + private subnets ajÃ¡nlott

---

#### 2. Compute (ECS Fargate)

##### Backend Service

```yaml
Task Definition:
  CPU: 512 (.5 vCPU)
  Memory: 1024 MB
  Container:
    - Name: backend
      Image: ${ECR_REGISTRY}/knowledgerouter-backend:latest
      Port: 8000
      Environment:
        - DJANGO_SETTINGS_MODULE=core.settings
        - OPENAI_API_KEY=${SECRETS_MANAGER_OPENAI_KEY}
        - QDRANT_HOST=qdrant.knowledge_network.local
        - REDIS_HOST=redis.knowledge_network.local
        - POSTGRES_HOST=${RDS_ENDPOINT}
      HealthCheck:
        Command: ["CMD-SHELL", "curl -f http://localhost:8000/healthz || exit 1"]
        Interval: 30s
        Timeout: 5s
        Retries: 3

Service:
  DesiredCount: 2
  MinCount: 2
  MaxCount: 10
  AutoScaling:
    TargetCPU: 70%
    TargetMemory: 80%
    TargetRequestCountPerTarget: 1000
```

**Scaling Triggers:**
- CPU > 70% â†’ scale out
- Memory > 80% â†’ scale out
- ALB requests > 1000/target â†’ scale out
- Ã‰jszaka (01:00-06:00) â†’ scale down to 2

---

##### Frontend Service

```yaml
Task Definition:
  CPU: 256 (.25 vCPU)
  Memory: 512 MB
  Container:
    - Name: frontend
      Image: ${ECR_REGISTRY}/knowledgerouter-frontend:latest
      Port: 80
      
Service:
  DesiredCount: 2
  AutoScaling: âŒ Nincs (static HTML/CSS/JS)
```

**MiÃ©rt nincs auto-scaling?**
- Frontend = statikus fÃ¡jlok (Nginx)
- Nincs compute-intensive task
- 2 instance elegendÅ‘ (HA miatt)

---

##### Supporting Services

| Service | CPU | Memory | Replicas | Auto-Scale |
|---------|-----|--------|----------|------------|
| Qdrant | 512 | 1024 MB | 1 | âŒ Nincs (stateful) |
| Redis | 256 | 512 MB | 1 | âŒ Nincs (ElastiCache alternatÃ­va ajÃ¡nlott) |
| Prometheus | 512 | 1024 MB | 1 | âŒ Nincs |
| Grafana | 256 | 512 MB | 1 | âŒ Nincs |

**âš ï¸ Figyelj:** Qdrant Ã©s Redis **stateful** szolgÃ¡ltatÃ¡sok!
- Fargate-ben futtatva: **nincs perzisztencia** restart utÃ¡n
- **MegoldÃ¡s:**
  - Qdrant â†’ **EFS volume** csatolÃ¡sa (persistent vector storage)
  - Redis â†’ **ElastiCache Redis** managed service (AWS Ã¡ltal kezelve)

---

#### 3. Database (RDS PostgreSQL)

```yaml
RDS Instance:
  Engine: PostgreSQL 15.4
  InstanceClass: db.t3.micro
  AllocatedStorage: 20 GB (gp3 SSD)
  MultiAZ: true  # High Availability
  BackupRetentionPeriod: 7 days
  AutoMinorVersionUpgrade: true
  DeletionProtection: true
  
  SecurityGroup:
    Ingress: 
      - Port 5432 from ECS tasks security group only
```

**KÃ¶ltsÃ©g:**
- db.t3.micro Multi-AZ: ~$30/hÃ³
- Storage (20GB gp3): ~$3/hÃ³
- **Ã–sszesen: ~$33/hÃ³**

**MiÃ©rt nem Fargate PostgreSQL?**
- âŒ Nincs perzisztencia (restart = adatvesztÃ©s)
- âŒ Nincs automatikus backup
- âŒ Nincs read replica
- âœ… RDS: Managed, Multi-AZ, automated backups

---

#### 4. Storage & Data

##### S3 Buckets

| Bucket | HasznÃ¡lat | Lifecycle Policy |
|--------|-----------|------------------|
| `terraform-state-benke-tibor` | Terraform state fÃ¡jlok | Versioning ON, encryption AES-256 |
| `knowledgerouter-data` | User uploads, RAG documents | 30 nap utÃ¡n Standard-IA, 90 nap utÃ¡n Glacier |
| `knowledgerouter-backups` | Database dumps, vector DB backups | 7 nap retention |

##### EFS Volume (Elastic File System)

```yaml
EFS:
  Name: knowledgerouter-qdrant-data
  PerformanceMode: generalPurpose
  ThroughputMode: bursting
  Encryption: true
  
  MountTargets:
    - SubnetId: public_subnet_1
    - SubnetId: public_subnet_2
```

**HasznÃ¡lat:**
- Qdrant task-ok ide mountoljÃ¡k a `/qdrant/storage` kÃ¶nyvtÃ¡rat
- Perzisztens vector storage (restart-proof)

**KÃ¶ltsÃ©g:**
- ~$0.30/GB/month (General Purpose)
- BecsÃ¼lt hasznÃ¡lat: 5GB â†’ ~$1.50/hÃ³

---

#### 5. Secrets Management

##### AWS Secrets Manager

```json
Secrets:
  /knowledgerouter/openai-api-key:
    Type: SecureString
    Value: sk-proj-...
    
  /knowledgerouter/confluence-credentials:
    Type: JSON
    Value:
      base_url: https://your-domain.atlassian.net
      email: user@example.com
      api_token: ATATT3xFfG...
      
  /knowledgerouter/jira-credentials:
    Type: JSON
    
  /knowledgerouter/postgres-password:
    Type: SecureString
    RotationSchedule: 90 days
```

**ECS Task Integration:**

```hcl
# Terraform: Task Definition
container_definitions = jsonencode([
  {
    name = "backend"
    secrets = [
      {
        name      = "OPENAI_API_KEY"
        valueFrom = aws_secretsmanager_secret_version.openai.arn
      },
      {
        name      = "POSTGRES_PASSWORD"
        valueFrom = aws_secretsmanager_secret_version.postgres.arn
      }
    ]
  }
])
```

**KÃ¶ltsÃ©g:**
- $0.40/secret/month â†’ 4 secrets = $1.60/hÃ³
- $0.05/10,000 API calls â†’ becsÃ¼lt $0.50/hÃ³

---

#### 6. Monitoring & Logging

##### CloudWatch Logs

```yaml
Log Groups:
  /ecs/knowledgerouter/backend:
    RetentionInDays: 7
    
  /ecs/knowledgerouter/frontend:
    RetentionInDays: 3
    
  /ecs/knowledgerouter/qdrant:
    RetentionInDays: 7
    
  /ecs/knowledgerouter/prometheus:
    RetentionInDays: 3
```

**Log Insights Queries:**
```sql
-- Top 10 slowest API endpoints
fields @timestamp, request_path, duration
| filter @message like /api/chat/
| stats avg(duration) by request_path
| sort avg(duration) desc
| limit 10
```

**KÃ¶ltsÃ©g:**
- Ingestion: $0.50/GB â†’ becsÃ¼lt 10GB/hÃ³ = $5/hÃ³
- Storage: $0.03/GB â†’ becsÃ¼lt 50GB = $1.50/hÃ³

---

##### CloudWatch Alarms

```yaml
Alarms:
  BackendHighCPU:
    Metric: ECS/CPUUtilization
    Threshold: 80%
    EvaluationPeriods: 2
    AlarmActions:
      - SNS Topic: devops-alerts
      
  BackendHighMemory:
    Metric: ECS/MemoryUtilization
    Threshold: 85%
    
  ALBUnhealthyTargets:
    Metric: ALB/UnHealthyHostCount
    Threshold: 1
    
  RDSHighConnections:
    Metric: RDS/DatabaseConnections
    Threshold: 80
```

---

##### Prometheus + Grafana (ECS Fargate)

**Prometheus scrape config:**

```yaml
scrape_configs:
  - job_name: 'ecs-backend'
    ec2_sd_configs:
      - region: eu-central-1
        port: 8000
        filters:
          - name: tag:Service
            values: [knowledgerouter-backend]
    relabel_configs:
      - source_labels: [__meta_ec2_tag_Name]
        target_label: instance
```

**Grafana Dashboards:**
1. **LangGraph Execution Metrics**
   - Node execution time (intent â†’ plan â†’ retrieval â†’ generation)
   - Guardrail retry rate
   - Tool selection distribution

2. **RAG Performance**
   - Qdrant query latency
   - Embedding generation time
   - Citation relevance score distribution

3. **Infrastructure Metrics**
   - ECS CPU/Memory utilization
   - ALB request count & latency
   - RDS connections & query time

---

## Terraform InfrastruktÃºra

### FÃ¡jlstruktÃºra

```
terraform/
â”œâ”€â”€ backend.tf              # S3 + DynamoDB state backend
â”œâ”€â”€ provider.tf             # AWS provider konfig
â”œâ”€â”€ variables.tf            # Input vÃ¡ltozÃ³k
â”œâ”€â”€ outputs.tf              # Output Ã©rtÃ©kek
â”œâ”€â”€ vpc.tf                  # VPC, subnets, IGW, route tables
â”œâ”€â”€ security-groups.tf      # Security group rules
â”œâ”€â”€ iam.tf                  # IAM roles (ECS task execution, GitHub OIDC)
â”œâ”€â”€ ecr.tf                  # Docker image registry
â”œâ”€â”€ rds.tf                  # PostgreSQL database
â”œâ”€â”€ efs.tf                  # EFS volume (Qdrant storage)
â”œâ”€â”€ ecs-cluster.tf          # ECS cluster
â”œâ”€â”€ ecs-backend.tf          # Backend task definition + service
â”œâ”€â”€ ecs-frontend.tf         # Frontend task definition + service
â”œâ”€â”€ ecs-qdrant.tf           # Qdrant task definition + service
â”œâ”€â”€ ecs-redis.tf            # Redis task definition + service
â”œâ”€â”€ ecs-monitoring.tf       # Prometheus + Grafana tasks
â”œâ”€â”€ alb.tf                  # Application Load Balancer
â”œâ”€â”€ auto-scaling.tf         # ECS auto-scaling policies
â”œâ”€â”€ cloudwatch.tf           # Log groups + alarms
â”œâ”€â”€ secrets-manager.tf      # Secrets definitions
â””â”€â”€ service-discovery.tf    # ECS Service Discovery (internal DNS)

terraform-bootstrap/
â”œâ”€â”€ backend.tf              # Local state (bootstrap only)
â”œâ”€â”€ provider.tf
â”œâ”€â”€ main.tf                 # S3 bucket + DynamoDB table
```

---

### Kiemelt Terraform Blokkok

#### VPC Setup (vpc.tf)

```hcl
resource "aws_vpc" "main" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true
  enable_dns_support   = true

  tags = {
    Name        = "knowledgerouter-vpc"
    Environment = var.environment
    ManagedBy   = "Terraform"
  }
}

# Public Subnets (Multi-AZ)
resource "aws_subnet" "public" {
  count                   = 2
  vpc_id                  = aws_vpc.main.id
  cidr_block              = "10.0.${count.index + 1}.0/24"
  availability_zone       = data.aws_availability_zones.available.names[count.index]
  map_public_ip_on_launch = true

  tags = {
    Name = "knowledgerouter-public-${count.index + 1}"
  }
}

# Internet Gateway
resource "aws_internet_gateway" "main" {
  vpc_id = aws_vpc.main.id

  tags = {
    Name = "knowledgerouter-igw"
  }
}
```

---

#### ECS Service Discovery (service-discovery.tf)

```hcl
# Private DNS namespace
resource "aws_service_discovery_private_dns_namespace" "main" {
  name = "knowledge.local"
  vpc  = aws_vpc.main.id
}

# Qdrant service discovery
resource "aws_service_discovery_service" "qdrant" {
  name = "qdrant"

  dns_config {
    namespace_id = aws_service_discovery_private_dns_namespace.main.id

    dns_records {
      ttl  = 10
      type = "A"
    }
  }
}

# Redis service discovery
resource "aws_service_discovery_service" "redis" {
  name = "redis"

  dns_config {
    namespace_id = aws_service_discovery_private_dns_namespace.main.id

    dns_records {
      ttl  = 10
      type = "A"
    }
  }
}
```

**HasznÃ¡lat a backend kontÃ©nerben:**
```python
# core/settings.py
QDRANT_HOST = os.getenv("QDRANT_HOST", "qdrant.knowledge.local")
REDIS_HOST = os.getenv("REDIS_HOST", "redis.knowledge.local")
```

**ElÅ‘nyÃ¶k:**
- Nincs hardcoded IP cÃ­m
- Auto-update DNS ha kontÃ©ner IP vÃ¡ltozik
- Load balancing beÃ©pÃ­tett (ha tÃ¶bb replica)

---

#### Backend Task Definition (ecs-backend.tf)

```hcl
resource "aws_ecs_task_definition" "backend" {
  family                   = "knowledgerouter-backend"
  network_mode             = "awsvpc"
  requires_compatibilities = ["FARGATE"]
  cpu                      = "512"
  memory                   = "1024"
  execution_role_arn       = aws_iam_role.ecs_task_execution.arn
  task_role_arn            = aws_iam_role.ecs_task.arn

  container_definitions = jsonencode([
    {
      name  = "backend"
      image = "${aws_ecr_repository.backend.repository_url}:latest"
      
      portMappings = [
        {
          containerPort = 8000
          protocol      = "tcp"
        }
      ]

      environment = [
        {
          name  = "DJANGO_SETTINGS_MODULE"
          value = "core.settings"
        },
        {
          name  = "QDRANT_HOST"
          value = "qdrant.knowledge.local"
        },
        {
          name  = "REDIS_HOST"
          value = "redis.knowledge.local"
        },
        {
          name  = "POSTGRES_HOST"
          value = aws_db_instance.postgres.endpoint
        }
      ]

      secrets = [
        {
          name      = "OPENAI_API_KEY"
          valueFrom = aws_secretsmanager_secret_version.openai.arn
        },
        {
          name      = "POSTGRES_PASSWORD"
          valueFrom = aws_secretsmanager_secret_version.postgres.arn
        },
        {
          name      = "CONFLUENCE_BASE_URL"
          valueFrom = "${aws_secretsmanager_secret_version.confluence.arn}:base_url::"
        },
        {
          name      = "CONFLUENCE_API_TOKEN"
          valueFrom = "${aws_secretsmanager_secret_version.confluence.arn}:api_token::"
        }
      ]

      logConfiguration = {
        logDriver = "awslogs"
        options = {
          "awslogs-group"         = aws_cloudwatch_log_group.backend.name
          "awslogs-region"        = var.aws_region
          "awslogs-stream-prefix" = "ecs"
        }
      }

      healthCheck = {
        command     = ["CMD-SHELL", "curl -f http://localhost:8000/api/healthz || exit 1"]
        interval    = 30
        timeout     = 5
        retries     = 3
        startPeriod = 60
      }
    }
  ])

  tags = {
    Name = "knowledgerouter-backend-task"
  }
}
```

---

#### Auto-Scaling Policy (auto-scaling.tf)

```hcl
# Target tracking scaling policy - CPU
resource "aws_appautoscaling_policy" "backend_cpu" {
  name               = "knowledgerouter-backend-cpu-scaling"
  policy_type        = "TargetTrackingScaling"
  resource_id        = aws_appautoscaling_target.backend.resource_id
  scalable_dimension = aws_appautoscaling_target.backend.scalable_dimension
  service_namespace  = aws_appautoscaling_target.backend.service_namespace

  target_tracking_scaling_policy_configuration {
    predefined_metric_specification {
      predefined_metric_type = "ECSServiceAverageCPUUtilization"
    }

    target_value       = 70.0
    scale_in_cooldown  = 300  # 5 perc
    scale_out_cooldown = 60   # 1 perc
  }
}

# Target tracking scaling policy - Memory
resource "aws_appautoscaling_policy" "backend_memory" {
  name               = "knowledgerouter-backend-memory-scaling"
  policy_type        = "TargetTrackingScaling"
  resource_id        = aws_appautoscaling_target.backend.resource_id
  scalable_dimension = aws_appautoscaling_target.backend.scalable_dimension
  service_namespace  = aws_appautoscaling_target.backend.service_namespace

  target_tracking_scaling_policy_configuration {
    predefined_metric_specification {
      predefined_metric_type = "ECSServiceAverageMemoryUtilization"
    }

    target_value       = 80.0
    scale_in_cooldown  = 300
    scale_out_cooldown = 60
  }
}

# Scheduled scaling - Ã©jszakai scale down
resource "aws_appautoscaling_scheduled_action" "backend_scale_down" {
  name               = "knowledgerouter-backend-scale-down"
  service_namespace  = aws_appautoscaling_target.backend.service_namespace
  resource_id        = aws_appautoscaling_target.backend.resource_id
  scalable_dimension = aws_appautoscaling_target.backend.scalable_dimension
  schedule           = "cron(0 1 * * ? *)"  # 01:00 UTC minden nap

  scalable_target_action {
    min_capacity = 1
    max_capacity = 3
  }
}

# Scheduled scaling - reggeli scale up
resource "aws_appautoscaling_scheduled_action" "backend_scale_up" {
  name               = "knowledgerouter-backend-scale-up"
  service_namespace  = aws_appautoscaling_target.backend.service_namespace
  resource_id        = aws_appautoscaling_target.backend.resource_id
  scalable_dimension = aws_appautoscaling_target.backend.scalable_dimension
  schedule           = "cron(0 7 * * ? *)"  # 07:00 UTC minden nap

  scalable_target_action {
    min_capacity = 2
    max_capacity = 10
  }
}
```

---

## GitHub Actions CI/CD Pipeline

### Workflow File (.github/workflows/deploy.yml)

```yaml
name: Deploy KnowledgeRouter to AWS ECS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger

env:
  AWS_REGION: eu-central-1
  ECR_BACKEND_REPO: knowledgerouter-backend
  ECR_FRONTEND_REPO: knowledgerouter-frontend
  ECS_CLUSTER: knowledgerouter-cluster
  ECS_BACKEND_SERVICE: knowledgerouter-backend-service
  ECS_FRONTEND_SERVICE: knowledgerouter-frontend-service
  TERRAFORM_DIR: terraform

permissions:
  id-token: write  # AWS OIDC authentication
  contents: read

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Linting & Testing
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: Lint & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-cov black flake8

      - name: Run Black (formatter check)
        run: |
          cd backend
          black --check .

      - name: Run Flake8 (linter)
        run: |
          cd backend
          flake8 . --max-line-length=120 --exclude=migrations

      - name: Run Pytest
        env:
          DJANGO_SETTINGS_MODULE: core.settings
          OPENAI_API_KEY: sk-test-mock-key
          SECRET_KEY: test-secret-key
        run: |
          cd backend
          pytest tests/ --cov=services --cov=infrastructure --cov-report=xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: backend/coverage.xml
          flags: backend

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Build & Push Docker Images
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main'
    
    outputs:
      backend-image-tag: ${{ steps.meta.outputs.backend-tag }}
      frontend-image-tag: ${{ steps.meta.outputs.frontend-tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image tags
        id: meta
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          BACKEND_TAG="${ECR_REGISTRY}/${ECR_BACKEND_REPO}:${{ github.sha }}"
          FRONTEND_TAG="${ECR_REGISTRY}/${ECR_FRONTEND_REPO}:${{ github.sha }}"
          
          echo "backend-tag=${BACKEND_TAG}" >> $GITHUB_OUTPUT
          echo "frontend-tag=${FRONTEND_TAG}" >> $GITHUB_OUTPUT
          
          echo "Backend Image: ${BACKEND_TAG}"
          echo "Frontend Image: ${FRONTEND_TAG}"

      - name: Build Backend Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker build \
            -t ${ECR_REGISTRY}/${ECR_BACKEND_REPO}:${{ github.sha }} \
            -t ${ECR_REGISTRY}/${ECR_BACKEND_REPO}:latest \
            -f backend/Dockerfile .

      - name: Build Frontend Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker build \
            -t ${ECR_REGISTRY}/${ECR_FRONTEND_REPO}:${{ github.sha }} \
            -t ${ECR_REGISTRY}/${ECR_FRONTEND_REPO}:latest \
            -f frontend/Dockerfile .

      - name: Scan Backend Image (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_BACKEND_REPO }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-backend.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-backend.sarif'

      - name: Push Backend Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker push ${ECR_REGISTRY}/${ECR_BACKEND_REPO}:${{ github.sha }}
          docker push ${ECR_REGISTRY}/${ECR_BACKEND_REPO}:latest

      - name: Push Frontend Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker push ${ECR_REGISTRY}/${ECR_FRONTEND_REPO}:${{ github.sha }}
          docker push ${ECR_REGISTRY}/${ECR_FRONTEND_REPO}:latest

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Terraform Plan
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform init

      - name: Terraform Format Check
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform fmt -check

      - name: Terraform Validate
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform validate

      - name: Terraform Plan
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform plan -out=tfplan

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('${{ env.TERRAFORM_DIR }}/tfplan.txt', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Terraform Plan\n\`\`\`\n${plan}\n\`\`\``
            });

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 4: Deploy Infrastructure
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-infra:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform init

      - name: Terraform Apply
        working-directory: ${{ env.TERRAFORM_DIR }}
        env:
          TF_VAR_backend_image_tag: ${{ needs.build.outputs.backend-image-tag }}
          TF_VAR_frontend_image_tag: ${{ needs.build.outputs.frontend-image-tag }}
        run: terraform apply -auto-approve

      - name: Get Outputs
        id: tf-outputs
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          ALB_DNS=$(terraform output -raw alb_dns_name)
          echo "alb-dns=${ALB_DNS}" >> $GITHUB_OUTPUT
          echo "Application URL: http://${ALB_DNS}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 5: Deploy ECS Services
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-ecs:
    name: Deploy ECS Services
    runs-on: ubuntu-latest
    needs: [deploy-infra]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: Force Backend Service Update
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_BACKEND_SERVICE }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Force Frontend Service Update
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_FRONTEND_SERVICE }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Wait for Backend Service Stability
        run: |
          echo "â³ Waiting for backend service to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_BACKEND_SERVICE }} \
            --region ${{ env.AWS_REGION }}
          echo "âœ… Backend service is stable!"

      - name: Wait for Frontend Service Stability
        run: |
          echo "â³ Waiting for frontend service to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_FRONTEND_SERVICE }} \
            --region ${{ env.AWS_REGION }}
          echo "âœ… Frontend service is stable!"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 6: Smoke Tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-ecs, deploy-infra]

    steps:
      - name: Health Check - Backend
        env:
          ALB_DNS: ${{ needs.deploy-infra.outputs.alb-dns }}
        run: |
          echo "Testing backend health endpoint..."
          curl -f http://${ALB_DNS}/api/healthz || exit 1
          echo "âœ… Backend health check passed!"

      - name: Integration Test - Chat API
        env:
          ALB_DNS: ${{ needs.deploy-infra.outputs.alb-dns }}
        run: |
          echo "Testing chat API..."
          RESPONSE=$(curl -s -X POST http://${ALB_DNS}/api/chat/ \
            -H "Content-Type: application/json" \
            -d '{"message": "Test query", "session_id": "test-session"}')
          
          echo "Response: ${RESPONSE}"
          echo "${RESPONSE}" | jq -e '.answer' || exit 1
          echo "âœ… Chat API test passed!"

      - name: Performance Test - Response Time
        env:
          ALB_DNS: ${{ needs.deploy-infra.outputs.alb-dns }}
        run: |
          echo "Testing response time..."
          TIME=$(curl -o /dev/null -s -w '%{time_total}' http://${ALB_DNS}/api/healthz)
          echo "Response time: ${TIME}s"
          
          if (( $(echo "$TIME > 2.0" | bc -l) )); then
            echo "âŒ Response time too high!"
            exit 1
          fi
          echo "âœ… Performance test passed!"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 7: Notification
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [smoke-tests]
    if: always()

    steps:
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "ğŸš€ KnowledgeRouter Deployment",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Deployment Status:* ${{ job.status }}\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}"
                  }
                }
              ]
            }
```

### Pipeline Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GitHub Actions Pipeline                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Push   â”‚â”€â”€â”€â”€â–¶â”‚   Test   â”‚â”€â”€â”€â”€â–¶â”‚   Build   â”‚â”€â”€â”€â”€â–¶â”‚ Deploy   â”‚
â”‚ to main â”‚     â”‚ (pytest) â”‚     â”‚ (Docker)  â”‚     â”‚ (ECS)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                  â”‚                 â”‚
                     â–¼                  â–¼                 â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Lint    â”‚       â”‚ Trivy   â”‚      â”‚ Terraformâ”‚
                â”‚ (Black, â”‚       â”‚ Scan    â”‚      â”‚ Apply    â”‚
                â”‚ Flake8) â”‚       â”‚         â”‚      â”‚          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                                                         â–¼
                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                    â”‚ Smoke    â”‚
                                                    â”‚ Tests    â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                                                         â–¼
                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                    â”‚ Slack    â”‚
                                                    â”‚ Notify   â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## KÃ¶ltsÃ©gbecslÃ©s

### Havi KÃ¶ltsÃ©g Breakdown (EU-CENTRAL-1 rÃ©giÃ³)

| SzolgÃ¡ltatÃ¡s | KonfigurÃ¡ciÃ³ | BecsÃ¼lt KÃ¶ltsÃ©g |
|--------------|--------------|-----------------|
| **ECS Fargate - Backend** | 2-10 task (0.5 vCPU, 1GB RAM, avg 4 task, 24/7) | ~$50/hÃ³ |
| **ECS Fargate - Frontend** | 2 task (0.25 vCPU, 512MB RAM, 24/7) | ~$15/hÃ³ |
| **ECS Fargate - Qdrant** | 1 task (0.5 vCPU, 1GB RAM, 24/7) | ~$25/hÃ³ |
| **ECS Fargate - Redis** | 1 task (0.25 vCPU, 512MB RAM, 24/7) | ~$12/hÃ³ |
| **ECS Fargate - Prometheus** | 1 task (0.5 vCPU, 1GB RAM, 24/7) | ~$25/hÃ³ |
| **ECS Fargate - Grafana** | 1 task (0.25 vCPU, 512MB RAM, 24/7) | ~$12/hÃ³ |
| **RDS PostgreSQL** | db.t3.micro Multi-AZ (1 vCPU, 1GB RAM, 20GB storage) | ~$33/hÃ³ |
| **Application Load Balancer** | 1 ALB + 50GB/month data transfer | ~$22/hÃ³ |
| **EFS (Qdrant storage)** | 5GB General Purpose | ~$2/hÃ³ |
| **ECR** | 10GB image storage | ~$1/hÃ³ |
| **S3** | 5GB storage (Terraform state, backups) | ~$0.15/hÃ³ |
| **Secrets Manager** | 4 secrets | ~$2/hÃ³ |
| **CloudWatch Logs** | 10GB ingestion, 50GB storage | ~$7/hÃ³ |
| **CloudWatch Alarms** | 5 alarms | ~$0.50/hÃ³ |
| **Data Transfer** | 50GB outbound (internet) | ~$5/hÃ³ |
| **NAT Gateway** | âŒ NINCS (public subnet hasznÃ¡lat) | $0 |
| **VPC, Security Groups, Route Tables** | Ingyenes | $0 |
| **Secrets Manager API calls** | ~100,000 calls/month | ~$0.50/hÃ³ |

### **Ã–SSZESEN (kb.): ~$212/hÃ³**

---

### KÃ¶ltsÃ©goptimalizÃ¡lÃ¡si StratÃ©giÃ¡k

#### 1. Fargate Spot Instances (ğŸ’° ~60% megtakarÃ­tÃ¡s)

```hcl
# ecs-backend.tf
resource "aws_ecs_service" "backend" {
  capacity_provider_strategy {
    capacity_provider = "FARGATE_SPOT"
    weight            = 70  # 70% spot
    base              = 0
  }

  capacity_provider_strategy {
    capacity_provider = "FARGATE"
    weight            = 30  # 30% on-demand (stability)
    base              = 2   # Always 2 on-demand tasks
  }
}
```

**MegtakarÃ­tÃ¡s:**
- Backend: $50/hÃ³ â†’ $25/hÃ³ (50% kedvezmÃ©ny)
- Qdrant/Prometheus: $50/hÃ³ â†’ $25/hÃ³

**KockÃ¡zat:** AWS bÃ¡rmikor visszaveheti a spot task-okat (interrupt rate: ~5%)

---

#### 2. ElastiCache Redis Managed Service

```hcl
resource "aws_elasticache_cluster" "redis" {
  cluster_id           = "knowledgerouter-redis"
  engine               = "redis"
  node_type            = "cache.t3.micro"
  num_cache_nodes      = 1
  parameter_group_name = "default.redis7"
  engine_version       = "7.0"
  port                 = 6379
}
```

**KÃ¶ltsÃ©g:**
- cache.t3.micro: ~$12/hÃ³ (azonos a Fargate Redis task-kal)

**ElÅ‘nyÃ¶k:**
- âœ… Automatikus backups
- âœ… Nincs restart data loss
- âœ… Redis cluster mode (ha kell)
- âœ… CloudWatch integrÃ¡ciÃ³

---

#### 3. Scheduled Scaling (ğŸ’° ~30% megtakarÃ­tÃ¡s)

```yaml
MunkaidÅ‘ (08:00-18:00):
  Backend: 4-10 tasks
  
Ã‰jszaka (18:00-08:00):
  Backend: 2 tasks (minimum)
  
HÃ©tvÃ©ge:
  Backend: 1 task (csak health check)
```

**MegtakarÃ­tÃ¡s:**
- Ã‰jszaka: 50% kevesebb task (12 Ã³ra)
- HÃ©tvÃ©ge: 75% kevesebb task (48 Ã³ra)
- **Ãtlag megtakarÃ­tÃ¡s: ~30%**

---

#### 4. CloudWatch Log Retention Optimization

```hcl
resource "aws_cloudwatch_log_group" "backend" {
  name              = "/ecs/knowledgerouter/backend"
  retention_in_days = 3  # 7 helyett 3 nap
}

resource "aws_cloudwatch_log_group" "frontend" {
  name              = "/ecs/knowledgerouter/frontend"
  retention_in_days = 1  # 3 helyett 1 nap (static content)
}
```

**MegtakarÃ­tÃ¡s:** ~$3/hÃ³

---

#### 5. S3 Lifecycle Policies

```hcl
resource "aws_s3_bucket_lifecycle_configuration" "data" {
  bucket = aws_s3_bucket.data.id

  rule {
    id     = "archive-old-logs"
    status = "Enabled"

    transition {
      days          = 30
      storage_class = "STANDARD_IA"  # Infrequent Access (50% olcsÃ³bb)
    }

    transition {
      days          = 90
      storage_class = "GLACIER_INSTANT_RETRIEVAL"  # 80% olcsÃ³bb
    }

    expiration {
      days = 365  # 1 Ã©v utÃ¡n tÃ¶rlÃ©s
    }
  }
}
```

**MegtakarÃ­tÃ¡s:** ~$1/hÃ³ (kis adatmÃ©ret miatt kicsi a hatÃ¡s)

---

### OptimalizÃ¡lt KÃ¶ltsÃ©gbecslÃ©s

| OptimalizÃ¡lÃ¡s | Eredeti | OptimalizÃ¡lt | MegtakarÃ­tÃ¡s |
|---------------|---------|--------------|--------------|
| Fargate Spot (Backend + Monitoring) | $139/hÃ³ | $70/hÃ³ | **-$69/hÃ³ (-50%)** |
| Scheduled Scaling (Ã©jszaka/hÃ©tvÃ©ge) | $70/hÃ³ | $50/hÃ³ | **-$20/hÃ³ (-28%)** |
| Log Retention (3â†’1 nap) | $7/hÃ³ | $4/hÃ³ | **-$3/hÃ³ (-43%)** |
| **Ã–SSZESEN** | **$212/hÃ³** | **$120/hÃ³** | **-$92/hÃ³ (-43%)** |

---

## ImplementÃ¡ciÃ³s Ãœtemterv

### Sprint 1 (1 hÃ©t): Foundation

**CÃ©l:** AWS foundation + Terraform bootstrap

- [ ] AWS Account setup (IAM user, billing alerts)
- [ ] Terraform backend bootstrap (S3 + DynamoDB)
- [ ] GitHub OIDC provider setup (jelszÃ³ nÃ©lkÃ¼li deploy)
- [ ] Secrets Manager setup (OpenAI, Confluence, Jira credentials)
- [ ] ECR repositories lÃ©trehozÃ¡sa (backend, frontend)

**Deliverables:**
- Terraform state backend mÅ±kÃ¶dik
- GitHub Actions tud AWS-hez kapcsolÃ³dni
- Secrets Manager-ben vannak a credentialek

---

### Sprint 2 (1 hÃ©t): Networking & Database

**CÃ©l:** VPC + RDS PostgreSQL + Security Groups

- [ ] VPC + Public Subnets (2 AZ)
- [ ] Internet Gateway + Route Tables
- [ ] Security Groups (ALB, ECS, RDS)
- [ ] RDS PostgreSQL (db.t3.micro Multi-AZ)
- [ ] RDS connection test (psql)

**Deliverables:**
- RDS endpoint elÃ©rhetÅ‘ ECS tasks-bÃ³l
- Security Groups konfigurÃ¡lva (least privilege)

---

### Sprint 3 (1.5 hÃ©t): ECS Cluster & Core Services

**CÃ©l:** ECS Fargate backend + frontend + service discovery

- [ ] ECS Cluster lÃ©trehozÃ¡sa
- [ ] Service Discovery (qdrant.knowledge.local, redis.knowledge.local)
- [ ] Backend task definition + service (2 replicas)
- [ ] Frontend task definition + service (2 replicas)
- [ ] CloudWatch Log Groups
- [ ] IAM roles (task execution, task role)

**Deliverables:**
- Backend elÃ©rhetÅ‘ http://backend.knowledge.local:8000
- Frontend elÃ©rhetÅ‘ http://frontend.knowledge.local:80

---

### Sprint 4 (1 hÃ©t): Supporting Services

**CÃ©l:** Qdrant + Redis + Prometheus + Grafana

- [ ] EFS volume (Qdrant persistent storage)
- [ ] Qdrant task definition + EFS mount
- [ ] Redis task definition
- [ ] Prometheus task definition + config (scrape ECS tasks)
- [ ] Grafana task definition + dashboards

**Deliverables:**
- Qdrant vector DB mÅ±kÃ¶dik (persist restart utÃ¡n)
- Redis cache mÅ±kÃ¶dik
- Grafana dashboards lÃ¡tszanak

---

### Sprint 5 (1 hÃ©t): Load Balancer & Auto-Scaling

**CÃ©l:** ALB + health checks + auto-scaling policies

- [ ] Application Load Balancer
- [ ] Target Groups (backend, frontend)
- [ ] ALB Listeners (HTTP:80)
- [ ] Health checks konfigurÃ¡lÃ¡sa
- [ ] Auto-scaling policies (CPU, Memory, Request Count)
- [ ] Scheduled scaling (Ã©jszaka/hÃ©tvÃ©ge)

**Deliverables:**
- AlkalmazÃ¡s elÃ©rhetÅ‘ http://knowledgerouter-alb-123456789.eu-central-1.elb.amazonaws.com
- Auto-scaling mÅ±kÃ¶dik (CPU > 70% â†’ scale out)

---

### Sprint 6 (1 hÃ©t): CI/CD Pipeline

**CÃ©l:** GitHub Actions teljes pipeline

- [ ] Workflow file (.github/workflows/deploy.yml)
- [ ] Test job (pytest, black, flake8)
- [ ] Build job (Docker build + ECR push)
- [ ] Trivy security scan
- [ ] Terraform plan/apply job
- [ ] ECS service update job
- [ ] Smoke tests job

**Deliverables:**
- Push to main â†’ automatikus deployment
- Pull request â†’ Terraform plan komment
- Security scan eredmÃ©nyek GitHub Security tab-ban

---

### Sprint 7 (0.5 hÃ©t): Monitoring & Alerting

**CÃ©l:** CloudWatch Alarms + Slack notifications

- [ ] CloudWatch Alarms (CPU, Memory, UnhealthyTargets)
- [ ] SNS Topic (email alerts)
- [ ] Slack webhook integration
- [ ] Grafana alert rules (Prometheus metrics)

**Deliverables:**
- Email notification ha backend CPU > 80%
- Slack message minden deployment utÃ¡n

---

### Sprint 8 (0.5 hÃ©t): Documentation & Handover

**CÃ©l:** DokumentÃ¡ciÃ³ + runbook

- [ ] README.md frissÃ­tÃ©s (deployment instructions)
- [ ] Runbook (troubleshooting, rollback, scaling)
- [ ] Architecture diagram (draw.io/Lucidchart)
- [ ] Cost optimization guide

**Deliverables:**
- Teljes dokumentÃ¡ciÃ³ a GitHub repo-ban
- Team training session (deployment demo)

---

### **Ã–sszes IdÅ‘igÃ©ny: ~7-8 hÃ©t (1.75-2 hÃ³nap)**

---

## KockÃ¡zatelemzÃ©s

### Kritikus KockÃ¡zatok

#### 1. Qdrant Vector DB Perzisztencia

**ProblÃ©ma:**
- Qdrant Fargate task-kÃ©nt fut â†’ restart = adatvesztÃ©s
- Vector embeddings ÃºjragenerÃ¡lÃ¡sa kÃ¶ltsÃ©ges (OpenAI API)

**MegoldÃ¡s:**
- âœ… EFS volume csatolÃ¡sa (`/qdrant/storage`)
- âœ… AlternatÃ­va: Qdrant Cloud (managed service, $95/hÃ³)
- âœ… Backup: S3-ba exportÃ¡lÃ¡s (naponta cron job)

**KockÃ¡zat szint:** ğŸ”´ MAGAS

---

#### 2. Redis AdatvesztÃ©s (Cache + Sessions)

**ProblÃ©ma:**
- Redis restart â†’ cache + session adatok elvesznek
- Session loss = user logout (bad UX)

**MegoldÃ¡s:**
- âœ… ElastiCache Redis (managed, ~$12/hÃ³)
- âœ… Redis persistence (AOF vagy RDB)
- âœ… Session backend: PostgreSQL (fallback)

**KockÃ¡zat szint:** ğŸŸ¡ KÃ–ZEPES

---

#### 3. Secrets Manager Cost Explosion

**ProblÃ©ma:**
- Secrets Manager: $0.40/secret/month + $0.05/10,000 API calls
- ECS task minden restart = API call â†’ nagy terhelÃ©s = magas kÃ¶ltsÃ©g

**MegoldÃ¡s:**
- âœ… Secrets caching (1 Ã³ra TTL)
- âœ… Environment variables (nem titkos adatokhoz)
- âœ… Monitoring: CloudWatch metrics (GetSecretValue API calls)

**KockÃ¡zat szint:** ğŸŸ¡ KÃ–ZEPES

---

#### 4. Cold Start Latency (Scale Up)

**ProblÃ©ma:**
- ECS task start: 30-60 mÃ¡sodperc
- User vÃ¡rni kell + timeout lehetsÃ©ges

**MegoldÃ¡s:**
- âœ… Minimum 2 task mindig fusson (base capacity)
- âœ… Pre-warming: scheduled scale up (07:00 reggel)
- âœ… Health check start period: 60s (ne kill-elje korÃ¡n)

**KockÃ¡zat szint:** ğŸŸ¢ ALACSONY

---

#### 5. GitHub Actions OIDC Authentication Failure

**ProblÃ©ma:**
- OIDC token lejÃ¡r â†’ deployment fail
- Rossz role trust policy â†’ permission denied

**MegoldÃ¡s:**
- âœ… IAM role trust policy: GitHub repository pontosan megadva
- âœ… Manual trigger opciÃ³ (workflow_dispatch)
- âœ… Fallback: AWS CLI credentials (emergency only)

**KockÃ¡zat szint:** ğŸŸ¡ KÃ–ZEPES

---

#### 6. Terraform State Corruption

**ProblÃ©ma:**
- PÃ¡rhuzamos `terraform apply` â†’ state file corrupt
- State file tÃ¶rlÃ©se â†’ infrastruktÃºra orphaned

**MegoldÃ¡s:**
- âœ… DynamoDB state locking (pÃ¡rhuzamos futÃ¡s blokkolva)
- âœ… S3 versioning ON (state file backup)
- âœ… Terraform state backup (hetente S3-ba)

**KockÃ¡zat szint:** ğŸ”´ MAGAS

---

#### 7. OpenAI API Rate Limiting

**ProblÃ©ma:**
- LangGraph heavy usage â†’ OpenAI rate limit (429 error)
- User experience: error messages

**MegoldÃ¡s:**
- âœ… Exponential backoff retry (LangChain beÃ©pÃ­tett)
- âœ… Request throttling (max 100 req/perc)
- âœ… OpenAI tier upgrade (Tier 2: 3,500 RPM)

**KockÃ¡zat szint:** ğŸŸ¡ KÃ–ZEPES

---

## KÃ¶vetkezÅ‘ LÃ©pÃ©sek

### Immediate Actions (1 hÃ©t)

1. **AWS Account Setup**
   - [ ] IAM user lÃ©trehozÃ¡sa (admin jogokkal)
   - [ ] Billing alerts beÃ¡llÃ­tÃ¡sa ($50, $100, $150 threshold)
   - [ ] Cost Explorer engedÃ©lyezÃ©se

2. **Terraform Bootstrap**
   - [ ] S3 bucket: `terraform-state-benke-tibor`
   - [ ] DynamoDB tÃ¡bla: `terraform-state-lock`
   - [ ] Backend konfig tesztelÃ©se

3. **GitHub Repository Setup**
   - [ ] `.github/workflows/` mappa lÃ©trehozÃ¡sa
   - [ ] GitHub Secrets beÃ¡llÃ­tÃ¡sa (AWS_ACCOUNT_ID)
   - [ ] OIDC provider Terraform konfig

### Long-term Roadmap (3-6 hÃ³nap)

1. **Q2 2026: Multi-Region Deployment**
   - Primary: eu-central-1 (Frankfurt)
   - Secondary: us-east-1 (N. Virginia)
   - Route 53 failover routing

2. **Q3 2026: Kubernetes Migration**
   - ECS â†’ EKS migrÃ¡lÃ¡s
   - Helm charts deployment
   - ArgoCD GitOps

3. **Q4 2026: Cost Optimization**
   - Reserved Instances (1 Ã©v commitment)
   - Savings Plans
   - Fargate Spot 100% hasznÃ¡lat

---

## Ã–sszefoglalÃ¡s

### Mit tanultunk a tutorial alapjÃ¡n?

âœ… **AWS ECS Fargate:** Serverless container orchestration
âœ… **Terraform:** Infrastructure as Code (VPC, ECS, RDS, ALB)
âœ… **GitHub Actions:** CI/CD pipeline (OIDC authentication)
âœ… **Multi-AZ Deployment:** High availability
âœ… **Auto-scaling:** CPU/Memory/Request count alapÃº
âœ… **Secrets Management:** AWS Secrets Manager
âœ… **Monitoring:** CloudWatch Logs + Prometheus + Grafana

### SajÃ¡t projekt adaptÃ¡ciÃ³

**KÃ¼lÃ¶nbsÃ©gek az eredeti tutorial-hoz kÃ©pest:**

| Tutorial (AI Agent Demo) | KnowledgeRouter (SajÃ¡t) |
|-------------------------|-------------------------|
| 3 kontÃ©ner (app, prometheus, grafana) | 7 kontÃ©ner (backend, frontend, qdrant, redis, postgres, prometheus, grafana) |
| Nincs adatbÃ¡zis | PostgreSQL (RDS Multi-AZ) |
| Nincs vector DB | Qdrant (EFS persistent storage) |
| Nincs cache | Redis (ElastiCache javasolt) |
| 1 backend service | Backend + Frontend + 4 supporting service |
| EgyszerÅ± health check | Complex LangGraph orchestration |

### BecsÃ¼lt KÃ¶ltsÃ©g

- **Alap konfigurÃ¡ciÃ³:** ~$212/hÃ³
- **OptimalizÃ¡lt (Spot + Scheduled):** ~$120/hÃ³
- **ElsÅ‘ hÃ³nap (setup):** ~$250 (extra CloudWatch costs)

### ImplementÃ¡ciÃ³s IdÅ‘

- **Teljes deployment:** 7-8 hÃ©t
- **MVP (backend + frontend + RDS):** 4 hÃ©t
- **Production-ready:** 8 hÃ©t + 1 hÃ©t tesztelÃ©s

---

**KÃ©szÃ­tette:** Benke Tibor  
**DÃ¡tum:** 2026. januÃ¡r 31.  
**VerziÃ³:** 1.0  
**StÃ¡tusz:** Tervezet (Review szÃ¼ksÃ©ges)

**KÃ¶vetkezÅ‘ lÃ©pÃ©s:** Review + AWS Account setup + Sprint 1 kickoff
